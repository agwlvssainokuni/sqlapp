<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cherry.sqlapp.db.app.mapper.MetadataMapper">
	<resultMap id="BaseResultMap" type="cherry.sqlapp.db.gen.dto.SqlMetadata">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="ID" jdbcType="INTEGER" property="id" />
		<result column="SQL_TYPE" jdbcType="VARCHAR" property="sqlType" />
		<result column="NAME" jdbcType="VARCHAR" property="name" />
		<result column="DESCRIPTION" jdbcType="VARCHAR" property="description" />
		<result column="OWNED_BY" jdbcType="VARCHAR" property="ownedBy" />
		<result column="PUBLISHED_FLG" jdbcType="INTEGER" property="publishedFlg" />
		<result column="REGISTERED_AT" jdbcType="TIMESTAMP" property="registeredAt" />
		<result column="UPDATED_AT" jdbcType="TIMESTAMP" property="updatedAt" />
		<result column="CREATED_AT" jdbcType="TIMESTAMP" property="createdAt" />
		<result column="DELETED_FLG" jdbcType="INTEGER" property="deletedFlg" />
	</resultMap>
	<insert id="createSelect" parameterType="cherry.sqlapp.db.gen.dto.SqlMetadata"
		useGeneratedKeys="true" keyColumn="id" keyProperty="id">
		INSERT INTO sql_metadata (
			sql_type,
			name,
			description,
			owned_by
		)
		VALUES (
			'select',
			DEFAULT,
			#{description,jdbcType=VARCHAR},
			#{ownedBy,jdbcType=VARCHAR}
		)
	</insert>
	<insert id="createAny" parameterType="cherry.sqlapp.db.gen.dto.SqlMetadata"
		useGeneratedKeys="true" keyColumn="id" keyProperty="id">
		INSERT INTO sql_metadata (
			sql_type,
			name,
			description,
			owned_by
		)
		VALUES (
			'any',
			DEFAULT,
			#{description,jdbcType=VARCHAR},
			#{ownedBy,jdbcType=VARCHAR}
		)
	</insert>
	<insert id="createCsv" parameterType="cherry.sqlapp.db.gen.dto.SqlMetadata"
		useGeneratedKeys="true" keyColumn="id" keyProperty="id">
		INSERT INTO sql_metadata (
			sql_type,
			name,
			description,
			owned_by
		)
		VALUES (
			'csv',
			DEFAULT,
			#{description,jdbcType=VARCHAR},
			#{ownedBy,jdbcType=VARCHAR}
		)
	</insert>
	<update id="update" parameterType="cherry.sqlapp.db.gen.dto.SqlMetadata">
		UPDATE sql_metadata
		SET
			name = #{name,jdbcType=VARCHAR},
			description = #{description,jdbcType=VARCHAR},
			published_flg = #{publishedFlg,jdbcType=INTEGER},
			updated_at = CURRENT_TIMESTAMP
		WHERE
			id = #{id,jdbcType=INTEGER}
			AND
			deleted_flg = 0
	</update>
	<select id="search" parameterType="cherry.sqlapp.db.app.mapper.SqlCondition" resultMap="BaseResultMap">
	SELECT
		A.id,
		A.sqlType,
		A.name,
		A.description,
		A.owned_by,
		A.published_flg,
		A.registered_at,
		A.updated_at,
		A.created_at,
		A.deleted_flg
	FROM
		sql_metadata AS A
	WHERE
		A.deleted_at = 0
		<if test="name != null">AND A.name LIKE #{name,jdbcType=VARCHAR}</if>
		<if test="registeredFrom">AND A.registered_at &gt;= #{registeredFrom,jdbcType=TIMESTAMP}</if>
		<if test="registeredTo">AND A.registered_at &lt; #{registeredTo,jdbcType=TIMESTAMP}</if>
		AND (
		<choose>
		<when test="publish || notPublish">
			<trim prefixOverrides="OR">
				<if test="notPublish">A.published_flg = 0 AND A.owned_by = #{owner,jdbcType=VARCHAR}</if>
				<if test="publish">OR A.published_flg = 1</if>
			</trim>
		</when>
		<otherwise>A.published_flg = 1 OR A.owned_by = #{owner,jdbcType=VARCHAR}</otherwise>
		</choose>
		)
		<if test="select || any || csv">
		A.sql_type IN (
		<trim suffix=",">
			<if test="select">'select',</if>
			<if test="any">'any',</if>
			<if test="csv">'csv',</if>
		</trim>
		)
		</if>
	</select>
</mapper>
