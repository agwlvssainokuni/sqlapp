<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cherry.sqlapp.db.mapper.MetadataMapper">
	<resultMap id="BaseResultMap" type="cherry.sqlapp.db.dto.SqltoolMetadata">
		<id column="ID" jdbcType="INTEGER" property="id" />
		<result column="SQL_TYPE" jdbcType="VARCHAR" property="sqlType" />
		<result column="NAME" jdbcType="VARCHAR" property="name" />
		<result column="DESCRIPTION" jdbcType="VARCHAR" property="description" />
		<result column="OWNED_BY" jdbcType="VARCHAR" property="ownedBy" />
		<result column="PUBLISHED_FLG" jdbcType="INTEGER" property="publishedFlg" />
		<result column="REGISTERED_AT" jdbcType="TIMESTAMP" property="registeredAt" />
		<result column="UPDATED_AT" jdbcType="TIMESTAMP" property="updatedAt" />
		<result column="CREATED_AT" jdbcType="TIMESTAMP" property="createdAt" />
		<result column="DELETED_FLG" jdbcType="INTEGER" property="deletedFlg" />
	</resultMap>
	<select id="count" resultType="int">
		SELECT
			COUNT(*)
		FROM
			sqltool_metadata AS A
		WHERE
			<if test="cond.name != null">A.name LIKE #{cond.name,jdbcType=VARCHAR} AND</if>
			<if test="cond.registeredFrom">A.registered_at &gt;= #{cond.registeredFrom,jdbcType=TIMESTAMP} AND</if>
			<if test="cond.registeredTo">A.registered_at &lt; #{cond.registeredTo,jdbcType=TIMESTAMP} AND</if>
			(
			<choose>
			<when test="cond.publish || cond.notPublish">
				<trim prefixOverrides="OR">
					<if test="cond.notPublish">(A.published_flg = 0 AND A.owned_by = #{cond.loginId,jdbcType=VARCHAR})</if>
					<if test="cond.publish">OR A.published_flg &lt;&gt; 0</if>
				</trim>
			</when>
			<otherwise>A.published_flg &lt;&gt; 0 OR A.owned_by = #{cond.loginId,jdbcType=VARCHAR}</otherwise>
			</choose>
			) AND
			<if test="cond.clause || cond.statement || cond.load">
			A.sql_type IN (
			<trim suffixOverrides=",">
				<if test="cond.clause">'clause',</if>
				<if test="cond.statement">'statement',</if>
				<if test="cond.load">'load'</if>
			</trim>
			) AND
			</if>
			A.deleted_flg = 0
	</select>
	<select id="search" resultMap="BaseResultMap">
		SELECT
			A.id,
			A.sql_type,
			A.name,
			A.description,
			A.owned_by,
			A.published_flg,
			A.registered_at,
			A.updated_at,
			A.created_at,
			A.deleted_flg
		FROM
			sqltool_metadata AS A
		WHERE
			<if test="cond.name != null">A.name LIKE #{cond.name,jdbcType=VARCHAR} AND</if>
			<if test="cond.registeredFrom">A.registered_at &gt;= #{cond.registeredFrom,jdbcType=TIMESTAMP} AND</if>
			<if test="cond.registeredTo">A.registered_at &lt; #{cond.registeredTo,jdbcType=TIMESTAMP} AND</if>
			(
			<choose>
			<when test="cond.publish || cond.notPublish">
				<trim prefixOverrides="OR">
					<if test="cond.notPublish">(A.published_flg = 0 AND A.owned_by = #{cond.loginId,jdbcType=VARCHAR})</if>
					<if test="cond.publish">OR A.published_flg &lt;&gt; 0</if>
				</trim>
			</when>
			<otherwise>A.published_flg &lt;&gt; 0 OR A.owned_by = #{cond.loginId,jdbcType=VARCHAR}</otherwise>
			</choose>
			) AND
			<if test="cond.clause || cond.statement || cond.load">
			A.sql_type IN (
			<trim suffixOverrides=",">
				<if test="cond.clause">'clause',</if>
				<if test="cond.statement">'statement',</if>
				<if test="cond.load">'load'</if>
			</trim>
			) AND
			</if>
			A.deleted_flg = 0
		LIMIT #{limit,jdbcType=INTEGER} OFFSET #{offset,jdbcType=INTEGER}
	</select>
</mapper>
